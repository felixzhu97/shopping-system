@startuml Clean Architecture Class Diagram - Product Module
!theme plain
skinparam backgroundColor #FFFFFF
skinparam classAttributeIconSize 0

title 整洁架构类图 - Product 模块

' Domain Layer
package "Domain Layer" {
  class Product {
    - id: string
    - name: string
    - description: string
    - price: Money
    - category: string
    - stock: number
    + validate(): void
    + isInStock(): boolean
    + reduceStock(quantity: number): void
  }
  
  class Money {
    - amount: number
    - currency: string
    + add(other: Money): Money
    + multiply(factor: number): Money
    + isGreaterThan(other: Money): boolean
  }
  
  interface IProductRepository {
    + findById(id: string): Promise<Product | null>
    + findByCategory(category: string): Promise<Product[]>
    + findAll(): Promise<Product[]>
    + save(product: Product): Promise<void>
    + delete(id: string): Promise<void>
  }
  
  class DomainError {
    + message: string
    + code: string
  }
  
  Product --> Money : uses
  Product --> DomainError : throws
}

' Application Layer
package "Application Layer" {
  class GetProductsUseCase {
    - productRepository: IProductRepository
    - logger: ILogger
    + execute(query: GetProductsQuery): Promise<Product[]>
    - normalizeCategory(category?: string): string
  }
  
  class CreateProductUseCase {
    - productRepository: IProductRepository
    - logger: ILogger
    + execute(dto: CreateProductDto): Promise<Product>
    - validateDto(dto: CreateProductDto): void
  }
  
  class UpdateProductUseCase {
    - productRepository: IProductRepository
    - logger: ILogger
    + execute(id: string, dto: UpdateProductDto): Promise<Product>
  }
  
  class DeleteProductUseCase {
    - productRepository: IProductRepository
    - logger: ILogger
    + execute(id: string): Promise<void>
  }
  
  class CreateProductDto {
    + name: string
    + description: string
    + price: number
    + category: string
    + stock: number
  }
  
  class UpdateProductDto {
    + name?: string
    + description?: string
    + price?: number
    + category?: string
    + stock?: number
  }
  
  class GetProductsQuery {
    + category?: string
  }
  
  interface ILogger {
    + info(message: string): void
    + error(message: string): void
  }
  
  GetProductsUseCase ..> IProductRepository : depends on
  CreateProductUseCase ..> IProductRepository : depends on
  UpdateProductUseCase ..> IProductRepository : depends on
  DeleteProductUseCase ..> IProductRepository : depends on
  
  GetProductsUseCase --> Product : returns
  CreateProductUseCase --> Product : creates
  UpdateProductUseCase --> Product : updates
  DeleteProductUseCase --> Product : deletes
  
  GetProductsUseCase ..> ILogger : uses
  CreateProductUseCase ..> ILogger : uses
  UpdateProductUseCase ..> ILogger : uses
  DeleteProductUseCase ..> ILogger : uses
  
  CreateProductUseCase --> CreateProductDto : uses
  UpdateProductUseCase --> UpdateProductDto : uses
  GetProductsUseCase --> GetProductsQuery : uses
}

' Infrastructure Layer
package "Infrastructure Layer" {
  class ProductRepository {
    - productModel: Model<ProductDocument>
    + findById(id: string): Promise<Product | null>
    + findByCategory(category: string): Promise<Product[]>
    + findAll(): Promise<Product[]>
    + save(product: Product): Promise<void>
    + delete(id: string): Promise<void>
  }
  
  class ProductModel {
    + _id: ObjectId
    + name: string
    + description: string
    + price: number
    + category: string
    + stock: number
    + timestamps
  }
  
  class ProductMapper {
    + toDomain(model: ProductDocument): Product
    + toModel(entity: Product): ProductDocument
  }
  
  class ProductController {
    - getProductsUseCase: GetProductsUseCase
    - createProductUseCase: CreateProductUseCase
    - updateProductUseCase: UpdateProductUseCase
    - deleteProductUseCase: DeleteProductUseCase
    + getAllProducts(req: Request, res: Response): Promise<void>
    + getProductById(req: Request, res: Response): Promise<void>
    + createProduct(req: Request, res: Response): Promise<void>
    + updateProduct(req: Request, res: Response): Promise<void>
    + deleteProduct(req: Request, res: Response): Promise<void>
  }
  
  class Logger {
    + info(message: string): void
    + error(message: string): void
  }
  
  ProductRepository ..|> IProductRepository : implements
  ProductRepository --> ProductModel : uses
  ProductRepository --> ProductMapper : uses
  ProductMapper --> Product : converts to
  ProductMapper --> ProductModel : converts from
  
  ProductController --> GetProductsUseCase : uses
  ProductController --> CreateProductUseCase : uses
  ProductController --> UpdateProductUseCase : uses
  ProductController --> DeleteProductUseCase : uses
  
  Logger ..|> ILogger : implements
}

' 依赖关系标注
note right of IProductRepository
  接口定义在 Domain 层
  实现在 Infrastructure 层
end note

note right of Product
  纯业务对象
  不依赖任何框架
end note

note right of GetProductsUseCase
  用例协调 Domain 对象
  通过接口访问数据
end note

@enduml

