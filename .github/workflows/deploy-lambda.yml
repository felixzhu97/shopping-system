name: 部署到AWS Lambda

on:
  push:
    branches: [main]
    paths:
      - 'apps/api/**'
      - 'packages/shared/**'
      - '.github/workflows/deploy-lambda.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: '部署环境'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: 设置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          cache-dependency-path: '**/package.json'

      - name: 安装依赖
        run: pnpm install --no-frozen-lockfile

      - name: 安装构建工具
        run: |
          pnpm add -Dw esbuild@0.20.2
          cd apps/api && pnpm add -D @types/swagger-jsdoc @types/swagger-ui-express
          cd ../../packages/shared && pnpm add -D esbuild@0.20.2
          cd ../ui && pnpm add -D esbuild@0.20.2

      - name: 列出UI包的源文件
        run: |
          echo "检查UI包源文件结构："
          ls -la packages/ui/src || echo "UI包src目录不存在"

      - name: 构建shared包
        run: cd packages/shared && pnpm build

      - name: 检查shared包输出
        run: ls -la packages/shared/dist

      - name: 尝试构建UI包
        run: cd packages/ui && ls && pnpm build || echo "UI包构建失败，但继续执行"
        continue-on-error: true

      - name: 检查UI包文件夹
        run: |
          echo "UI包根目录:"
          ls -la packages/ui/
          echo "查看是否有dist目录:"
          ls -la packages/ui/dist || echo "UI包dist目录不存在"

      - name: 构建API包
        run: cd apps/api && pnpm build

      - name: 检查API包输出
        run: ls -la apps/api/dist

      - name: 创建环境变量文件
        run: |
          cd apps/api
          echo "NODE_ENV=production" > .env.production
          echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" >> .env.production
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env.production
          echo "已创建部署环境变量文件："
          cat .env.production

      - name: 添加环境变量到serverless.yml
        run: |
          cd apps/api
          echo "正在确保serverless.yml中包含所有需要的环境变量"
          grep -q "JWT_SECRET:" serverless.yml || sed -i '/environment:/a\    JWT_SECRET: ${env:JWT_SECRET}' serverless.yml

      - name: 部署到AWS Lambda
        run: cd apps/api && cp .env.production .env && pnpm dlx serverless@3 deploy
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
